# @package _global_

defaults:
  - override /datamodule: resisc/resisc
  - override /module: cps
  - override /scheduler@module.scheduler: multistep
  - override /network@module.network: efficientnet
  - override /network@module.network2: efficientnet
  - override /trainer: gpu
  - override /transforms@datamodule.to_0_1: to_0_1
  - override /transforms@datamodule.train_tf: none
  - override /transforms@datamodule.test_tf: none
  - override /transforms@module.batch_tf: none

# all parameters below will be merged with parameters from default configurations set above
# this allows you to overwrite only specified parameters

#ckpt: "/data/outputs/semcity/run_sup/2023-10-01_171911/checkpoints/last.ckpt"

datamodule:
    #city: TOULOUSE
    num_workers: 5
    batch_size_s: 4
    batch_size_u: 4
    pin_memory: true
    steps_per_epoch: 10
    sup: 1
    unsup: 1
    train_tf:
        _target_: dl_toolbox.transforms.Compose
        transforms: 
            - _target_: dl_toolbox.transforms.RandomCrop2
              size: 256
            - _target_: dl_toolbox.transforms.D4
            - _target_: dl_toolbox.transforms.Color
              bounds: [0.6,1.4]
    
module:
    scheduler:
        milestones: [80]
    network:
        weights: IMAGENET1K_V1
        #encoder_weights: imagenet
    metric_ignore_index: 0
    dice_loss: null


callbacks:
    feature_ft:
        unfreeze_at_epoch: 90

name: toulouse_${datamodule.sup}_sup
            
trainer:
  max_time: "00:11:30:59"
  #max_steps: 200000
  max_epochs: 10
  limit_train_batches: 1.
  limit_val_batches: 1.
    
hydra:
  run:
    dir: ${paths.output_dir}/${name}/${now:%Y-%m-%d_%H%M%S}
  sweeper:
    params:
      seed: 1
      module.optimizer.lr: 0.01
      module.optimizer.momentum: 0.9
      callbacks.feature_ft.do_finetune: true
      #module.alpha_ramp.val: 0.1,0.5,1,5
      #transforms@module.consistency_tf: cutmix,color,crop_resize
  sweep:
    dir: ${paths.output_dir}/${name}/${now:%Y-%m-%d_%H%M%S}
    subdir: seed_${seed}_lr_${module.optimizer.lr}_${module.optimizer.momentum}
#  launcher:
   # setup:
#        - cp -r /scratchm/pfournie/data/NWPU-RESISC45 /scratch/pfournie
#        - rsync -rvl --include="img_multispec_05/" --include="semantic_05/" --include="TLS_BDSD_RGB/" --include="TLS_indMap/" --include="*.tif" --exclude="*" /work/AI4GEO/users/fournip/SemCity-Toulouse-bench/ $TMPDIR/SemCity-Toulouse-bench/
#        - rsync -rvl --include="*.npy" --include="TOULOUSE/" --include="*[0-9].tif" --include="COS43/" --exclude="*" ${paths.data}/DIGITANIE_v4/ $TMPDIR/DIGITANIE_v4/
    
callbacks.model_checkpoint.dirpath: ${hydra:sweep.dir}/${hydra:sweep.subdir}/checkpoints
    